name: Check absence updates

on:
    schedule:
        - cron: "0 * * * *" # Runs every hour
    workflow_dispatch: # Allow manual triggering

jobs:
    check-files:
        runs-on: ubuntu-latest

        steps:
            - name: Verify md5 checksum of the absence page
              # Accesses https://www.canva.com/design/DAGS1jbtVUs/ZtauRcJI71IwuK5Afkb8fQ/view and gets the md5 checksum of the page
              run: |
                  expected_md5="aea6b27225143ded0e73412d49feb2f9"
                  actual_md5=$(curl -s https://www.canva.com/design/DAGS1jbtVUs/ZtauRcJI71IwuK5Afkb8fQ/view | md5sum | cut -d' ' -f1)

                  if [ "$expected_md5" != "$actual_md5" ]; then
                    echo "MISMATCH DETECTED"
                    exit 1
                  else
                    echo "âœ“ Absence page unchanged"
                  fi

            - name: Create issue if files changed
              if: failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      const issueTitle = `Absence page update detected`;
                      const issueBody = `
                      ## File Update Detected

                      New absence page has been detected.

                      **Details:**
                      - **Page**: https://www.canva.com/design/DAGS1jbtVUs/ZtauRcJI71IwuK5Afkb8fQ/view
                      - **MD5**: \`${actual_md5}\`
                      - **Detection Date**: ${new Date().toISOString().split('T')[0]}

                      **Action Required:**
                      Please check the absence page and update the data accordingly.

                      **File URLs:**
                      - [Absence page](https://www.canva.com/design/DAGS1jbtVUs/ZtauRcJI71IwuK5Afkb8fQ/view)

                      ---
                      *This issue was automatically created by the absence page monitoring workflow.*
                      `;

                      // Check if there's already an open issue for this file
                      const existingIssues = await github.rest.issues.listForRepo({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: 'open',
                        labels: ['absence-page-update']
                      });

                      const existingIssue = existingIssues.data.find(issue => 
                        issue.title.includes('Absence page update detected')
                      );

                      if (existingIssue) {
                        // Update existing issue
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: existingIssue.number,
                          body: `
                          ## New Update Detected
                          
                          ## Another update has been detected for **Absence page**:
                          - **Page**: https://www.canva.com/design/DAGS1jbtVUs/ZtauRcJI71IwuK5Afkb8fQ/view
                          - **MD5**: \`${actual_md5}\`
                          - **Detection Date**: ${new Date().toISOString().split('T')[0]}
                          `
                        });
                      } else {
                        // Create new issue
                        await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: issueTitle,
                          body: issueBody,
                          labels: ['absence-page-update', 'automated']
                        });
                      }
